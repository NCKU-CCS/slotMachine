var jsdom = require('jsdom');
var path = require('path');
var fs = require('fs');
var marked  = require('marked');
var jquery = fs.readFileSync(path.resolve(__dirname, 'jquery.min.js'), {encoding: 'utf-8'});

var mdtag = function(html_path, cb) {

	var html = fs.readFileSync(html_path, {encoding: 'utf-8'})
	mdtag.dom(html, path.dirname(html_path), cb);
}

mdtag.html = function(html, dir, cb) {
	return mdtag.dom(html, dir, cb);
}

mdtag.dom = function(html, dir, cb) {
	jsdom.env({
		html: html,
		src: [jquery],
		done: function (errors, window) {
			var $ = window.$;
			$('*[data-markdown]').each(function() {
				var src = $(this).attr('data-markdown');
				if(src.trim() !== '') {
					// have attribute
					var text = mdtag.fetch(src, dir)
				}else {
					// don't have attribue
					var text = $(this).text();
				}
				var html_text = mdtag.toHtml(text);
				var replace_html = mdtag.replace(html_text, $(this));
				$('.jsdom').remove();
				
			})
			cb(mdtag.getPageHtml($))
		}
	});
}

mdtag.fetch = function(route, dirname) {
	var ab_route = path.join(dirname, route)
	var page = fs.readFileSync(ab_route, {encoding: 'utf-8'})
	return page;
}

mdtag.toHtml = function(md) {
	return marked(md);
}

mdtag.replace = function(html, mdtag) {
	return mdtag.replaceWith(html)
}

mdtag.getPageHtml = function($) {
  return $("*")[0].outerHTML;
}

module.exports = mdtag;
