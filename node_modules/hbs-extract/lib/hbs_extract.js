var Handlebars = require('handlebars');
var path = require('path');
var FS = require("q-io/fs");
var Q = require('q');
var ImportScanner = require('./import_scanner');

exports.raw = function (content, afterKeyCreate) {
  var ast = Handlebars.parse(content);
  var scanner = new ImportScanner(afterKeyCreate);

  // visit handlebar statements
  scanner.accept(ast);
  return scanner.data;
};

exports.fromFile = function (hbsFile, afterKeyCreate) {
  var deferred = Q.defer();
 
  FS.read(hbsFile)
    .then(function(content) { 
      var ast = Handlebars.parse(content);
      var scanner = new ImportScanner(afterKeyCreate);
      // visit handlebar statements
      scanner.accept(ast);
      deferred.resolve(scanner.data);
    })
    .catch(function(err) {
      deferred.reject(new Error(err));
    });

  return deferred.promise;
};

exports.ImportScanner = ImportScanner;
