#!/usr/bin/env node
var prog = require('commander');
var path = require('path');
var Q = require('q');
var FS = require("q-io/fs");
var util = require('util');
var _ = require('lodash');
var hbs_extract = require('../index');
var beautify_js = require('js-beautify').js_beautify;

var pkg = require('../package.json');

var printErr = function(err) {
  console.log(chalk.red(err));
  console.log(err.stack);
}


var arg = process.argv;

prog
	.usage('[options] <hbs_template, default value: "index.hbs">')
  .option('-o, --output [filename]', 'output result to a json file.')
  .parse(arg);

extract(prog.args);

function extract(args) {
  var hbsFile = args[0] ? args[0] : './index.hbs';

  return hbs_extract.fromFile(hbsFile) 
    .then(function(data) {
      var str = beautify_js(JSON.stringify(data));
      if (!prog.output) {
        console.log(str);
        process.exit(1);
      }

      return FS.write(prog.output, str);
    })
    .then(function() {
      console.log('successfully write result to ' + prog.output);
    })
    .catch(function(err) {
      console.error(err);
    })
}

// General options
prog
  .version(pkg.version)

// if empty
if(_.isEmpty(prog.args) && process.argv.length === 2) {
    prog.help();
}
